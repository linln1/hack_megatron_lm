# Megatron-LM æ¶æ„å›¾ä¸æ–‡ä»¶åŠŸèƒ½è¯´æ˜

> ä»è½¯ä»¶å·¥ç¨‹è§’åº¦åˆ†æ Megatron-LM é¡¹ç›®çš„æ ¸å¿ƒç›®å½•æ¶æ„ï¼ŒåŒ…å«æ¶æ„å›¾å’Œæ¯ä¸ªæ–‡ä»¶çš„åŠŸèƒ½è¯´æ˜ã€‚

---

## ğŸ“ æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Megatron-LM é¡¹ç›®ç»“æ„                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Core  â”‚            â”‚ Training  â”‚        â”‚ Examples  â”‚
    â”‚       â”‚            â”‚           â”‚        â”‚           â”‚
    â”‚ æ ¸å¿ƒåº“ â”‚            â”‚ è®­ç»ƒæ¡†æ¶  â”‚        â”‚ ç¤ºä¾‹ä»£ç   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Tools & Tests   â”‚
                    â”‚   å·¥å…·ä¸æµ‹è¯•      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. megatron/core/ - æ ¸å¿ƒåº“æ¶æ„

Megatron Core æ˜¯é¡¹ç›®çš„æ ¸å¿ƒåº“ï¼Œæä¾›å¯ç»„åˆçš„æ¨¡å—åŒ– APIã€‚

### 1.1 æ ¸å¿ƒç›®å½•æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         megatron/core/ æ ¸å¿ƒåº“æ¶æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          é…ç½®ä¸çŠ¶æ€ç®¡ç†                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  config.py (é…ç½®ç³»ç»Ÿ)                                                        â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  parallel_state.py (å¹¶è¡ŒçŠ¶æ€ç®¡ç†) â”€â”€â”€â”€â”                                      â”‚
â”‚       â”‚                              â”‚                                      â”‚
â”‚       â–¼                              â”‚                                      â”‚
â”‚  utils.py (å·¥å…·å‡½æ•°)                  â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                              â”‚                              â”‚
        â–¼                              â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼ é‡å¹¶è¡Œ      â”‚            â”‚  æµæ°´çº¿å¹¶è¡Œ    â”‚            â”‚  æ•°æ®å¹¶è¡Œ      â”‚
â”‚  tensor_      â”‚            â”‚  pipeline_    â”‚            â”‚  distributed/ â”‚
â”‚  parallel/    â”‚            â”‚  parallel/     â”‚            â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                              â”‚                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Transformer æ ¸å¿ƒç»„ä»¶ (transformer/)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  transformer_config.py                â”‚                                      â”‚
â”‚       â”‚                               â”‚                                      â”‚
â”‚       â–¼                               â”‚                                      â”‚
â”‚  transformer_layer.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â”œâ”€â”€â–º transformer_block.py                                            â”‚
â”‚       â”œâ”€â”€â–º attention.py (æ³¨æ„åŠ›æœºåˆ¶)                                         â”‚
â”‚       â”œâ”€â”€â–º mlp.py (MLPå±‚)                                                   â”‚
â”‚       â””â”€â”€â–º moe/ (MoEå±‚)                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ¨¡å‹å®ç° (models/)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GPTæ¨¡å‹  â”‚  â”‚ BERTæ¨¡å‹ â”‚  â”‚ T5æ¨¡å‹   â”‚  â”‚ Mambaæ¨¡å‹â”‚  â”‚ MoEæ¨¡å‹  â”‚   â”‚
â”‚  â”‚ gpt/     â”‚  â”‚ bert/    â”‚  â”‚ T5/      â”‚  â”‚ mamba/   â”‚  â”‚          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚              â”‚              â”‚              â”‚              â”‚        â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â–¼                                               â”‚
â”‚                       å¹¶è¡Œç­–ç•¥ç»„åˆ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                              â”‚                              â”‚
        â–¼                              â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®é›†        â”‚            â”‚  ä¼˜åŒ–å™¨       â”‚            â”‚  æ¨ç†å¼•æ“      â”‚
â”‚  datasets/     â”‚            â”‚  optimizer/   â”‚            â”‚  inference/   â”‚
â”‚                â”‚            â”‚               â”‚            â”‚               â”‚
â”‚  - æ•°æ®é›†åŠ è½½å™¨ â”‚            â”‚  - ä¼˜åŒ–å™¨å®ç°  â”‚            â”‚  - æ¨ç†æœåŠ¡å™¨  â”‚
â”‚  - æ•°æ®é›†æ„å»ºå™¨ â”‚            â”‚  - åˆ†å¸ƒå¼ä¼˜åŒ–å™¨â”‚            â”‚  - æ¨ç†å¼•æ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ–‡ä»¶åŠŸèƒ½è¯´æ˜

#### é…ç½®ä¸çŠ¶æ€ç®¡ç†

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `config.py` | æ ¸å¿ƒé…ç½®ç±»ï¼Œå®šä¹‰æ‰€æœ‰é…ç½®å‚æ•° |
| `model_parallel_config.py` | æ¨¡å‹å¹¶è¡Œé…ç½®ï¼ˆTP/PP/CP/EPå‚æ•°ï¼‰ |
| `parallel_state.py` | **æ ¸å¿ƒ**ï¼šç®¡ç†æ‰€æœ‰å¹¶è¡Œç»„ï¼ˆTP/PP/DP/CP/EPï¼‰ï¼Œæä¾›å¹¶è¡Œç»„æŸ¥è¯¢æ¥å£ |
| `process_groups_config.py` | Process Group é…ç½®å’Œåˆå§‹åŒ– |
| `enums.py` | æšä¸¾ç±»å‹å®šä¹‰ï¼ˆModelType, AttnMaskTypeç­‰ï¼‰ |
| `utils.py` | é€šç”¨å·¥å…·å‡½æ•°ï¼ˆå†…å­˜ç®¡ç†ã€NVTXæ ‡è®°ç­‰ï¼‰ |

#### Transformer æ ¸å¿ƒç»„ä»¶ (`transformer/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `transformer_config.py` | Transformer é…ç½®ç±»ï¼ˆå±‚æ•°ã€éšè—å±‚å¤§å°ã€æ³¨æ„åŠ›å¤´æ•°ç­‰ï¼‰ |
| `transformer_layer.py` | **æ ¸å¿ƒ**ï¼šå•ä¸ª Transformer å±‚çš„å®ç°ï¼ˆå‰å‘/åå‘ä¼ æ’­ï¼‰ |
| `transformer_block.py` | Transformer å—ï¼ˆAttention + MLPï¼‰çš„ç»„åˆ |
| `attention.py` | æ³¨æ„åŠ›æœºåˆ¶å®ç°ï¼ˆæ”¯æŒå¤šç§æ³¨æ„åŠ›ç±»å‹ï¼‰ |
| `dot_product_attention.py` | ç‚¹ç§¯æ³¨æ„åŠ›è®¡ç®— |
| `mlp.py` | MLPï¼ˆå‰é¦ˆç½‘ç»œï¼‰å±‚å®ç° |
| `module.py` | Transformer æ¨¡å—åŸºç±» |
| `torch_layer_norm.py` | Layer Normalization å®ç° |
| `torch_norm.py` | å½’ä¸€åŒ–å±‚åŸºç±» |
| `cuda_graphs.py` | CUDA Graphs æ”¯æŒï¼ˆå‡å°‘å†…æ ¸å¯åŠ¨å¼€é”€ï¼‰ |
| `spec_utils.py` | Layer Spec å·¥å…·å‡½æ•° |
| `utils.py` | Transformer å·¥å…·å‡½æ•° |

**MoE å­æ¨¡å—** (`transformer/moe/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `moe_layer.py` | **æ ¸å¿ƒ**ï¼šMoE å±‚å®ç°ï¼ˆä¸“å®¶è·¯ç”±å’Œè®¡ç®—ï¼‰ |
| `router.py` | è·¯ç”±ç­–ç•¥ï¼ˆTop-Kè·¯ç”±ã€è´Ÿè½½å‡è¡¡ï¼‰ |
| `token_dispatcher.py` | Token åˆ†å‘å™¨ï¼ˆå°†tokenåˆ†å‘åˆ°ä¸åŒä¸“å®¶ï¼‰ |
| `experts.py` | ä¸“å®¶ç½‘ç»œå®ç° |
| `shared_experts.py` | å…±äº«ä¸“å®¶å®ç° |
| `fused_a2a.py` | All-to-All é€šä¿¡èåˆä¼˜åŒ– |
| `grouped_gemm_util.py` | åˆ†ç»„GEMMä¼˜åŒ–å·¥å…· |
| `moe_utils.py` | MoE å·¥å…·å‡½æ•° |

**èåˆå†…æ ¸** (`fusions/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `fused_bias_gelu.py` | èåˆçš„ Bias + GELU æ¿€æ´» |
| `fused_bias_swiglu.py` | èåˆçš„ Bias + SwiGLU æ¿€æ´» |
| `fused_layer_norm.py` | èåˆçš„ Layer Normalization |
| `fused_softmax.py` | èåˆçš„ Softmax |
| `fused_cross_entropy.py` | èåˆçš„äº¤å‰ç†µæŸå¤± |
| `fused_indices_converter.py` | ç´¢å¼•è½¬æ¢èåˆ |

#### æ¨¡å‹å®ç° (`models/`)

**GPT æ¨¡å‹** (`models/gpt/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `gpt_model.py` | **æ ¸å¿ƒ**ï¼šGPT æ¨¡å‹å®Œæ•´å®ç° |
| `gpt_layer_specs.py` | GPT å±‚è§„èŒƒå®šä¹‰ |
| `fine_grained_callables.py` | ç»†ç²’åº¦å¯è°ƒç”¨å¯¹è±¡ |
| `moe_module_specs.py` | MoE æ¨¡å—è§„èŒƒ |

**é€šç”¨ç»„ä»¶** (`models/common/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `embeddings/language_model_embedding.py` | è¯­è¨€æ¨¡å‹åµŒå…¥å±‚ |
| `embeddings/rotary_pos_embedding.py` | RoPEï¼ˆæ—‹è½¬ä½ç½®ç¼–ç ï¼‰ |
| `embeddings/yarn_rotary_pos_embedding.py` | YaRN RoPEï¼ˆå¯æ‰©å±•çš„RoPEï¼‰ |
| `embeddings/relative_pos_embedding.py` | ç›¸å¯¹ä½ç½®ç¼–ç  |
| `language_module/language_module.py` | è¯­è¨€æ¨¡å—åŸºç±» |
| `vision_module/vision_module.py` | è§†è§‰æ¨¡å—åŸºç±» |

**å…¶ä»–æ¨¡å‹**

| ç›®å½• | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `models/bert/` | BERT æ¨¡å‹å®ç° |
| `models/T5/` | T5 æ¨¡å‹å®ç° |
| `models/mamba/` | Mambaï¼ˆçŠ¶æ€ç©ºé—´æ¨¡å‹ï¼‰å®ç° |
| `models/multimodal/` | å¤šæ¨¡æ€æ¨¡å‹ï¼ˆLLaVAç­‰ï¼‰ |
| `models/retro/` | RETRO æ¨¡å‹å®ç° |
| `models/vision/` | è§†è§‰æ¨¡å‹ï¼ˆViTã€CLIPç­‰ï¼‰ |

#### å¹¶è¡Œç­–ç•¥å®ç°

**å¼ é‡å¹¶è¡Œ** (`tensor_parallel/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `layers.py` | **æ ¸å¿ƒ**ï¼šTPå±‚å®ç°ï¼ˆColumnParallelLinear, RowParallelLinearï¼‰ |
| `mappings.py` | TPé€šä¿¡æ˜ å°„ï¼ˆgather, scatter, reduceç­‰ï¼‰ |
| `cross_entropy.py` | è¯æ±‡è¡¨å¹¶è¡Œäº¤å‰ç†µ |
| `data.py` | æ•°æ®å¹¿æ’­ |
| `random.py` | éšæœºæ•°ç”Ÿæˆå™¨ç®¡ç†ï¼ˆç¡®ä¿TPç»„å†…ä¸€è‡´æ€§ï¼‰ |
| `utils.py` | TPå·¥å…·å‡½æ•° |
| `inference_layers.py` | æ¨ç†æ—¶çš„TPå±‚ |

**æµæ°´çº¿å¹¶è¡Œ** (`pipeline_parallel/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `schedules.py` | **æ ¸å¿ƒ**ï¼šæµæ°´çº¿è°ƒåº¦ç­–ç•¥ï¼ˆ1F1Bã€Interleaved 1F1Bï¼‰ |
| `p2p_communication.py` | ç‚¹å¯¹ç‚¹é€šä¿¡ï¼ˆPipelineé˜¶æ®µé—´é€šä¿¡ï¼‰ |
| `combined_1f1b.py` | ç»„åˆ1F1Bè°ƒåº¦å®ç° |
| `bridge_communicator.py` | Bridgeé€šä¿¡å™¨ |
| `utils.py` | PPå·¥å…·å‡½æ•° |

**æ•°æ®å¹¶è¡Œ** (`distributed/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `distributed_data_parallel.py` | **æ ¸å¿ƒ**ï¼šæ ‡å‡†DDPå®ç° |
| `distributed_data_parallel_config.py` | DDPé…ç½® |
| `data_parallel_base.py` | æ•°æ®å¹¶è¡ŒåŸºç±» |
| `finalize_model_grads.py` | æ¢¯åº¦æœ€ç»ˆåŒ–ï¼ˆè·¨DPç»„åŒæ­¥ï¼‰ |
| `param_and_grad_buffer.py` | å‚æ•°å’Œæ¢¯åº¦ç¼“å†²åŒº |
| `reduce_scatter_with_fp32_accumulation.py` | FP32ç´¯ç§¯çš„Reduce-Scatter |

**FSDP** (`distributed/fsdp/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `fsdp/src/megatron_fsdp/megatron_fsdp.py` | **æ ¸å¿ƒ**ï¼šMegatron FSDPå®ç° |
| `fsdp/src/megatron_fsdp/fully_shard.py` | å®Œå…¨åˆ†ç‰‡å®ç° |
| `fsdp/src/megatron_fsdp/distributed_data_parallel_config.py` | FSDPé…ç½® |
| `torch_fully_sharded_data_parallel.py` | PyTorch FSDP2åŒ…è£…å™¨ |

#### æ•°æ®é›† (`datasets/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `megatron_dataset.py` | **æ ¸å¿ƒ**ï¼šMegatronæ•°æ®é›†åŸºç±» |
| `gpt_dataset.py` | GPTæ•°æ®é›†å®ç° |
| `bert_dataset.py` | BERTæ•°æ®é›†å®ç° |
| `t5_dataset.py` | T5æ•°æ®é›†å®ç° |
| `multimodal_dataset.py` | å¤šæ¨¡æ€æ•°æ®é›† |
| `blended_megatron_dataset_builder.py` | **æ ¸å¿ƒ**ï¼šæ··åˆæ•°æ®é›†æ„å»ºå™¨ |
| `blended_megatron_dataset_config.py` | æ··åˆæ•°æ®é›†é…ç½® |
| `indexed_dataset.py` | ç´¢å¼•æ•°æ®é›†ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰ |
| `megatron_tokenizer.py` | TokenizeråŒ…è£…å™¨ |
| `helpers.py` | C++è¾…åŠ©å‡½æ•°ï¼ˆPythonç»‘å®šï¼‰ |
| `utils.py` | æ•°æ®é›†å·¥å…·å‡½æ•° |
| `object_storage_utils.py` | å¯¹è±¡å­˜å‚¨å·¥å…·ï¼ˆS3ç­‰ï¼‰ |

#### ä¼˜åŒ–å™¨ (`optimizer/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `optimizer.py` | **æ ¸å¿ƒ**ï¼šä¼˜åŒ–å™¨åŸºç±»å’Œå®ç° |
| `distrib_optimizer.py` | **æ ¸å¿ƒ**ï¼šåˆ†å¸ƒå¼ä¼˜åŒ–å™¨ï¼ˆåˆ†ç‰‡ä¼˜åŒ–å™¨çŠ¶æ€ï¼‰ |
| `optimizer_config.py` | ä¼˜åŒ–å™¨é…ç½® |
| `grad_scaler.py` | æ¢¯åº¦ç¼©æ”¾å™¨ï¼ˆæ··åˆç²¾åº¦è®­ç»ƒï¼‰ |
| `clip_grads.py` | æ¢¯åº¦è£å‰ª |
| `qk_clip.py` | QKæ³¨æ„åŠ›è£å‰ª |
| `cpu_offloading/hybrid_optimizer.py` | CPUå¸è½½ä¼˜åŒ–å™¨ |

#### æ¨ç†å¼•æ“ (`inference/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `text_generation_server/` | æ–‡æœ¬ç”ŸæˆæœåŠ¡å™¨å®ç° |
| `scheduler.py` | **æ ¸å¿ƒ**ï¼šæ‰¹å¤„ç†è°ƒåº¦å™¨ |
| `engines/` | æ¨ç†å¼•æ“å®ç° |
| `sampling_params.py` | é‡‡æ ·å‚æ•°é…ç½® |
| `inference_request.py` | æ¨ç†è¯·æ±‚å°è£… |
| `communication/` | æ¨ç†é€šä¿¡å·¥å…· |
| `contexts/` | æ¨ç†ä¸Šä¸‹æ–‡ç®¡ç† |
| `unified_memory.py` | ç»Ÿä¸€å†…å­˜ç®¡ç† |

#### æ£€æŸ¥ç‚¹ (`dist_checkpointing/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `core.py` | **æ ¸å¿ƒ**ï¼šåˆ†å¸ƒå¼æ£€æŸ¥ç‚¹æ ¸å¿ƒé€»è¾‘ |
| `state_dict_utils.py` | çŠ¶æ€å­—å…¸å·¥å…· |
| `serialization.py` | åºåˆ—åŒ–å®ç° |
| `mapping.py` | æ£€æŸ¥ç‚¹æ˜ å°„ |
| `strategies/` | æ£€æŸ¥ç‚¹ç­–ç•¥ï¼ˆä¸åŒåˆ†ç‰‡ç­–ç•¥ï¼‰ |
| `optimizer.py` | ä¼˜åŒ–å™¨çŠ¶æ€æ£€æŸ¥ç‚¹ |

#### å…¶ä»–æ ¸å¿ƒæ¨¡å—

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `fp8_utils.py` | FP8ç²¾åº¦å·¥å…· |
| `fp4_utils.py` | FP4ç²¾åº¦å·¥å…· |
| `full_cuda_graph.py` | å®Œæ•´CUDA Graphæ”¯æŒ |
| `num_microbatches_calculator.py` | å¾®æ‰¹æ¬¡æ•°é‡è®¡ç®—å™¨ |
| `timers.py` | æ€§èƒ½è®¡æ—¶å™¨ |
| `nccl_allocator.py` | NCCLå†…å­˜åˆ†é…å™¨ |
| `hyper_comm_grid.py` | è¶…ç«‹æ–¹ä½“é€šä¿¡ç½‘æ ¼ |
| `rerun_state_machine.py` | é‡è¿è¡ŒçŠ¶æ€æœºï¼ˆå®¹é”™ï¼‰ |
| `tokenizers/` | Tokenizerå®ç°ï¼ˆHuggingFaceã€GPT2ç­‰ï¼‰ |
| `export/trtllm/` | TensorRT-LLMå¯¼å‡ºå·¥å…· |
| `quantization/` | é‡åŒ–æ”¯æŒ |

---

## 2. megatron/training/ - è®­ç»ƒæ¡†æ¶æ¶æ„

è®­ç»ƒæ¡†æ¶æä¾›å®Œæ•´çš„è®­ç»ƒæµç¨‹ç®¡ç†ã€‚

### 2.1 è®­ç»ƒæ¡†æ¶æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      megatron/training/ è®­ç»ƒæ¡†æ¶                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®­ç»ƒä¸»æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  arguments.py (å‚æ•°è§£æ)                                                      â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  initialize.py (åˆå§‹åŒ–)                                                      â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  training.py (è®­ç»ƒä¸»å¾ªç¯)                                                     â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  checkpointing.py (æ£€æŸ¥ç‚¹ç®¡ç†)                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                              â”‚
        â”‚                              â”‚
        â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      datasets/             â”‚  â”‚      tokenizer/          â”‚
â”‚                            â”‚  â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ sft_dataset.py      â”‚  â”‚  â”‚  â”‚ tokenizer.py         â”‚ â”‚
â”‚  â”‚ (ç›‘ç£å¾®è°ƒæ•°æ®é›†)      â”‚  â”‚  â”‚  â”‚ (Tokenizerå®ç°)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚  â”‚           â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚           â”œâ”€â”€â–º bert_tokenization.py
â”‚  â”‚ fim_dataset.py      â”‚  â”‚  â”‚           â”‚
â”‚  â”‚ (å¡«å……ä¸­é—´ä»»åŠ¡)       â”‚  â”‚  â”‚           â””â”€â”€â–º gpt2_tokenization.py
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                           â”‚
â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚ data_samplers.py    â”‚  â”‚              â”‚
â”‚  â”‚ (æ•°æ®é‡‡æ ·å™¨)         â”‚  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚                            â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    training.py (è®­ç»ƒä¸»å¾ªç¯)
```

### 2.2 è®­ç»ƒæ¡†æ¶æ–‡ä»¶åŠŸèƒ½è¯´æ˜

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `arguments.py` | **æ ¸å¿ƒ**ï¼šå‘½ä»¤è¡Œå‚æ•°å®šä¹‰å’Œè§£æ |
| `yaml_arguments.py` | YAMLé…ç½®æ–‡ä»¶æ”¯æŒ |
| `argument_utils.py` | å‚æ•°å·¥å…·å‡½æ•° |
| `initialize.py` | **æ ¸å¿ƒ**ï¼šåˆ†å¸ƒå¼è®­ç»ƒåˆå§‹åŒ–ï¼ˆè®¾ç½®å¹¶è¡Œç»„ï¼‰ |
| `training.py` | **æ ¸å¿ƒ**ï¼šè®­ç»ƒä¸»å¾ªç¯é€»è¾‘ |
| `checkpointing.py` | æ£€æŸ¥ç‚¹ä¿å­˜å’ŒåŠ è½½ |
| `utils.py` | è®­ç»ƒå·¥å…·å‡½æ•° |
| `global_vars.py` | å…¨å±€å˜é‡ç®¡ç† |
| `config.py` | è®­ç»ƒé…ç½® |
| `async_utils.py` | å¼‚æ­¥å·¥å…· |
| `inprocess_restart.py` | è¿›ç¨‹å†…é‡å¯ï¼ˆå®¹é”™ï¼‰ |
| `dist_signal_handler.py` | åˆ†å¸ƒå¼ä¿¡å·å¤„ç† |
| `log_handler.py` | æ—¥å¿—å¤„ç† |
| `one_logger_utils.py` | OneLoggeré›†æˆ |
| `wandb_utils.py` | Weights & Biasesé›†æˆ |
| `theoretical_memory_usage.py` | ç†è®ºå†…å­˜ä½¿ç”¨è®¡ç®— |
| `ft_integration.py` | å®¹é”™é›†æˆ |

**æ•°æ®é›†** (`training/datasets/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `sft_dataset.py` | ç›‘ç£å¾®è°ƒæ•°æ®é›† |
| `fim_dataset.py` | Fill-in-the-Middleæ•°æ®é›† |
| `data_samplers.py` | æ•°æ®é‡‡æ ·å™¨ï¼ˆéšæœºã€é¡ºåºç­‰ï¼‰ |

**Tokenizer** (`training/tokenizer/`)

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `tokenizer.py` | TokenizeråŸºç±»å’Œå·¥å‚ |
| `bert_tokenization.py` | BERT Tokenizer |
| `gpt2_tokenization.py` | GPT2 Tokenizer |
| `multimodal_tokenizer.py` | å¤šæ¨¡æ€Tokenizer |
| `sft_tokenizer.py` | SFT Tokenizer |

---

## 3. æ ¹ç›®å½•è®­ç»ƒè„šæœ¬

### 3.1 è®­ç»ƒè„šæœ¬æ¶æ„

```
æ ¹ç›®å½•è®­ç»ƒè„šæœ¬
â”œâ”€â”€ pretrain_gpt.py          # GPTé¢„è®­ç»ƒ
â”œâ”€â”€ pretrain_bert.py         # BERTé¢„è®­ç»ƒ
â”œâ”€â”€ pretrain_t5.py           # T5é¢„è®­ç»ƒ
â”œâ”€â”€ pretrain_mamba.py        # Mambaé¢„è®­ç»ƒ
â”œâ”€â”€ pretrain_vlm.py          # è§†è§‰è¯­è¨€æ¨¡å‹
â”œâ”€â”€ pretrain_retro.py        # RETROé¢„è®­ç»ƒ
â”œâ”€â”€ train_rl.py              # å¼ºåŒ–å­¦ä¹ è®­ç»ƒ
â”œâ”€â”€ gpt_builders.py          # GPTæ¨¡å‹æ„å»ºå™¨
â””â”€â”€ model_provider.py        # æ¨¡å‹æä¾›è€…å·¥å‚
```

### 3.2 è®­ç»ƒè„šæœ¬åŠŸèƒ½è¯´æ˜

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| `pretrain_gpt.py` | **æ ¸å¿ƒ**ï¼šGPTæ¨¡å‹é¢„è®­ç»ƒä¸»è„šæœ¬ |
| `pretrain_bert.py` | BERTæ¨¡å‹é¢„è®­ç»ƒ |
| `pretrain_t5.py` | T5æ¨¡å‹é¢„è®­ç»ƒ |
| `pretrain_mamba.py` | Mambaæ¨¡å‹é¢„è®­ç»ƒ |
| `pretrain_vlm.py` | è§†è§‰è¯­è¨€æ¨¡å‹é¢„è®­ç»ƒ |
| `pretrain_retro.py` | RETROæ¨¡å‹é¢„è®­ç»ƒ |
| `pretrain_ict.py` | ICTï¼ˆInverse Cloze Taskï¼‰é¢„è®­ç»ƒ |
| `pretrain_vision_classify.py` | è§†è§‰åˆ†ç±»é¢„è®­ç»ƒ |
| `pretrain_vision_dino.py` | DINOè§†è§‰é¢„è®­ç»ƒ |
| `pretrain_vision_inpaint.py` | è§†è§‰ä¿®å¤é¢„è®­ç»ƒ |
| `train_rl.py` | å¼ºåŒ–å­¦ä¹ è®­ç»ƒï¼ˆRLHFç­‰ï¼‰ |
| `gpt_builders.py` | GPTæ¨¡å‹æ„å»ºå™¨å‡½æ•° |
| `mamba_builders.py` | Mambaæ¨¡å‹æ„å»ºå™¨ |
| `model_provider.py` | æ¨¡å‹æä¾›è€…å·¥å‚å‡½æ•° |

---

## 4. examples/ - ç¤ºä¾‹ä»£ç æ¶æ„

### 4.1 ç¤ºä¾‹ç›®å½•ç»“æ„

```
examples/
â”œâ”€â”€ run_simple_mcore_train_loop.py  # æœ€ç®€å•çš„è®­ç»ƒå¾ªç¯ç¤ºä¾‹
â”œâ”€â”€ gpt3/                            # GPT-3è®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ llama/                           # LLaMAè®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ mixtral/                         # Mixtral MoEè®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ mamba/                           # Mambaè®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ t5/                              # T5è®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ bert/                            # BERTè®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ multimodal/                      # å¤šæ¨¡æ€è®­ç»ƒç¤ºä¾‹
â”œâ”€â”€ inference/                       # æ¨ç†ç¤ºä¾‹
â”œâ”€â”€ export/                          # æ¨¡å‹å¯¼å‡ºç¤ºä¾‹
â”œâ”€â”€ retro/                           # RETROè®­ç»ƒç¤ºä¾‹
â””â”€â”€ rl/                              # å¼ºåŒ–å­¦ä¹ ç¤ºä¾‹
```

### 4.2 ç¤ºä¾‹åŠŸèƒ½è¯´æ˜

| ç›®å½•/æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|----------|---------|
| `run_simple_mcore_train_loop.py` | **å…¥é—¨å¿…è¯»**ï¼šæœ€ç®€å•çš„Megatron Coreè®­ç»ƒå¾ªç¯ |
| `gpt3/` | GPT-3æ¨¡å‹è®­ç»ƒé…ç½®å’Œè„šæœ¬ |
| `llama/` | LLaMAæ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `mixtral/` | Mixtral MoEæ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `mamba/` | MambaçŠ¶æ€ç©ºé—´æ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `t5/` | T5æ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `bert/` | BERTæ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `multimodal/` | å¤šæ¨¡æ€æ¨¡å‹ï¼ˆLLaVAç­‰ï¼‰è®­ç»ƒç¤ºä¾‹ |
| `inference/` | æ¨ç†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¤ºä¾‹ |
| `export/trtllm/` | TensorRT-LLMå¯¼å‡ºç¤ºä¾‹ |
| `retro/` | RETROæ¨¡å‹è®­ç»ƒç¤ºä¾‹ |
| `rl/` | å¼ºåŒ–å­¦ä¹ ï¼ˆRLHFã€DPOï¼‰ç¤ºä¾‹ |

---

## 5. tools/ - å·¥å…·é›†æ¶æ„

### 5.1 å·¥å…·ç›®å½•æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            tools/ å·¥å…·é›†æ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ preprocess_data  â”‚    â”‚   checkpoint/    â”‚    â”‚ run_text_gen    â”‚
â”‚ .py              â”‚    â”‚   æ£€æŸ¥ç‚¹è½¬æ¢      â”‚    â”‚ _server.py      â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚ æ•°æ®é¢„å¤„ç†        â”‚    â”‚ Megatron â†” HF    â”‚    â”‚ æ¨ç†æœåŠ¡å™¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ text_generation  â”‚    â”‚   tools/retro/   â”‚    â”‚   å…¶ä»–å·¥å…·       â”‚
â”‚ _cli.py          â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚                  â”‚    â”‚ RETROå·¥å…·        â”‚    â”‚ - æ€§èƒ½æµ‹è¯•       â”‚
â”‚ CLIå·¥å…·           â”‚    â”‚                  â”‚    â”‚ - å†…å­˜æŠ¥å‘Š       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å·¥å…·æ–‡ä»¶åŠŸèƒ½è¯´æ˜

| æ–‡ä»¶/ç›®å½• | åŠŸèƒ½è¯´æ˜ |
|----------|---------|
| `preprocess_data.py` | **æ ¸å¿ƒ**ï¼šæ•°æ®é¢„å¤„ç†å·¥å…·ï¼ˆJSONL â†’ äºŒè¿›åˆ¶ç´¢å¼•æ•°æ®é›†ï¼‰ |
| `preprocess_data_nmt.py` | æœºå™¨ç¿»è¯‘æ•°æ®é¢„å¤„ç† |
| `preprocess_mmdata.py` | å¤šæ¨¡æ€æ•°æ®é¢„å¤„ç† |
| `merge_datasets.py` | æ•°æ®é›†åˆå¹¶å·¥å…· |
| `checkpoint/` | æ£€æŸ¥ç‚¹è½¬æ¢å·¥å…·ï¼ˆMegatron â†” HuggingFaceï¼‰ |
| `checkpoint/convert.py` | æ£€æŸ¥ç‚¹æ ¼å¼è½¬æ¢ |
| `checkpoint/loader_core.py` | Coreæ ¼å¼æ£€æŸ¥ç‚¹åŠ è½½å™¨ |
| `checkpoint/loader_hf.py` | HuggingFaceæ ¼å¼åŠ è½½å™¨ |
| `checkpoint/saver_core.py` | Coreæ ¼å¼æ£€æŸ¥ç‚¹ä¿å­˜å™¨ |
| `checkpoint/saver_hf.py` | HuggingFaceæ ¼å¼ä¿å­˜å™¨ |
| `run_text_generation_server.py` | **æ ¸å¿ƒ**ï¼šæ–‡æœ¬ç”Ÿæˆæ¨ç†æœåŠ¡å™¨ |
| `run_mamba_text_generation_server.py` | Mambaæ¨ç†æœåŠ¡å™¨ |
| `run_vlm_text_generation.py` | è§†è§‰è¯­è¨€æ¨¡å‹æ¨ç† |
| `text_generation_cli.py` | å‘½ä»¤è¡Œæ–‡æœ¬ç”Ÿæˆå·¥å…· |
| `bert_embedding/` | BERTåµŒå…¥å·¥å…· |
| `retro/` | RETROç›¸å…³å·¥å…·ï¼ˆç´¢å¼•æ„å»ºã€æŸ¥è¯¢ç­‰ï¼‰ |
| `report_theoretical_memory.py` | ç†è®ºå†…å­˜ä½¿ç”¨æŠ¥å‘Š |
| `run_inference_performance_test.py` | æ¨ç†æ€§èƒ½æµ‹è¯• |
| `linter.py` | ä»£ç æ£€æŸ¥å·¥å…· |
| `check_copyright.py` | ç‰ˆæƒæ£€æŸ¥å·¥å…· |

---

## 6. æ•°æ®æµæ¶æ„

### 6.1 è®­ç»ƒæ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå§‹æ•°æ®     â”‚      â”‚   é¢„å¤„ç†å·¥å…·          â”‚      â”‚  äºŒè¿›åˆ¶æ•°æ®é›†     â”‚
â”‚              â”‚      â”‚                      â”‚      â”‚                  â”‚
â”‚  JSONLæ ¼å¼   â”‚ â”€â”€â”€â–º â”‚ preprocess_data.py   â”‚ â”€â”€â”€â–º â”‚ .bin + .idx      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚  æ•°æ®é›†åŠ è½½å™¨     â”‚
                                                    â”‚                  â”‚
                                                    â”‚  GPTDataset      â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚  DataLoader      â”‚
                                                    â”‚                  â”‚
                                                    â”‚  PyTorchæ•°æ®åŠ è½½  â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚   æ¨¡å‹è®­ç»ƒ        â”‚
                                                    â”‚                  â”‚
                                                    â”‚  å‰å‘/åå‘ä¼ æ’­    â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è®­ç»ƒæµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®­ç»ƒæµç¨‹æ¶æ„                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å¼€å§‹
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ–          â”‚
â”‚  initialize.py  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å»ºæ¨¡å‹        â”‚
â”‚  model_provider  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒ…è£…æ¨¡å‹        â”‚
â”‚  DDP/FSDP        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‡†å¤‡æ•°æ®        â”‚
â”‚  Dataset         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®­ç»ƒå¾ªç¯        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  training.py    â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
         â”‚                                                 â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                                 â”‚
         â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  å‰å‘ä¼ æ’­        â”‚                                       â”‚
â”‚  forward_step_  â”‚                                       â”‚
â”‚  func           â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                 â”‚
         â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  æµæ°´çº¿è°ƒåº¦      â”‚                                       â”‚
â”‚  schedules.py   â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                 â”‚
         â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  åå‘ä¼ æ’­        â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                 â”‚
         â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  æ¢¯åº¦åŒæ­¥        â”‚                                       â”‚
â”‚  finalize_model_â”‚                                       â”‚
â”‚  grads          â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                 â”‚
         â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  ä¼˜åŒ–å™¨æ›´æ–°      â”‚                                       â”‚
â”‚  optimizer.step â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                                 â”‚
         â–¼                                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    â”‚ä¿å­˜æ£€æŸ¥ç‚¹?â”‚                                           â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â”‚
         â”‚                                                 â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                           â”‚
    â”‚         â”‚                                           â”‚
   æ˜¯â”‚         â”‚å¦                                          â”‚
    â”‚         â”‚                                           â”‚
    â–¼         â”‚                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                           â”‚
â”‚ä¿å­˜æ£€æŸ¥ç‚¹â”‚  â”‚                                           â”‚
â”‚checkpointâ”‚  â”‚                                           â”‚
â”‚ing.py    â”‚  â”‚                                           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚                                           â”‚
     â”‚        â”‚                                           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å¹¶è¡Œé€šä¿¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¹¶è¡Œé€šä¿¡æ¶æ„                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   æ¨¡å‹    â”‚
                              â”‚  Model   â”‚
                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼ é‡å¹¶è¡Œ      â”‚          â”‚  æµæ°´çº¿å¹¶è¡Œ     â”‚          â”‚  æ•°æ®å¹¶è¡Œ      â”‚
â”‚               â”‚          â”‚               â”‚          â”‚               â”‚
â”‚  TP Group     â”‚          â”‚  PP Group     â”‚          â”‚  DP Group     â”‚
â”‚               â”‚          â”‚               â”‚          â”‚               â”‚
â”‚  All-Reduce   â”‚          â”‚  P2P Send/Recvâ”‚          â”‚  All-Reduce   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šä¸‹æ–‡å¹¶è¡Œ     â”‚          â”‚  ä¸“å®¶å¹¶è¡Œ      â”‚
â”‚               â”‚          â”‚               â”‚
â”‚  CP Group     â”‚          â”‚  EP Group     â”‚
â”‚               â”‚          â”‚               â”‚
â”‚  All-Gather   â”‚          â”‚  All-to-All   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å…³é”®æ¨¡å—ä¾èµ–å…³ç³»

### 7.1 æ ¸å¿ƒä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ ¸å¿ƒä¾èµ–å…³ç³»                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  parallel_state.py   â”‚
â”‚  (å¹¶è¡ŒçŠ¶æ€ç®¡ç†)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
    â–¼      â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TP   â”‚ â”‚ PP   â”‚ â”‚ DP       â”‚
â”‚      â”‚ â”‚      â”‚ â”‚          â”‚
â”‚tensorâ”‚ â”‚pipelineâ”‚ â”‚distributedâ”‚
â”‚parallelâ”‚ â”‚parallelâ”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ transformer_config.pyâ”‚
â”‚  (Transformeré…ç½®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ transformer_layer.py â”‚
â”‚  (Transformerå±‚)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
    â–¼      â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚attentionâ”‚ â”‚mlp.pyâ”‚
â”‚.py     â”‚ â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    gpt_model.py      â”‚
â”‚    (GPTæ¨¡å‹)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
    â–¼      â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚transformerâ”‚ â”‚parallel_stateâ”‚
â”‚layer     â”‚ â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    training.py       â”‚
â”‚    (è®­ç»ƒå¾ªç¯)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
    â–¼      â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚GPTModelâ”‚ â”‚optimizerâ”‚ â”‚checkpointâ”‚
â”‚       â”‚ â”‚        â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     datasets         â”‚
â”‚     (æ•°æ®é›†)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. å­¦ä¹ è·¯å¾„å»ºè®®

### 8.1 æŒ‰æ¨¡å—å­¦ä¹ é¡ºåº

1. **åŸºç¡€ç†è§£**ï¼ˆç¬¬1å‘¨ï¼‰
   - `parallel_state.py` - ç†è§£å¹¶è¡Œç»„ç®¡ç†
   - `config.py` - ç†è§£é…ç½®ç³»ç»Ÿ
   - `examples/run_simple_mcore_train_loop.py` - ç†è§£åŸºæœ¬è®­ç»ƒæµç¨‹

2. **Transformeræ ¸å¿ƒ**ï¼ˆç¬¬2-3å‘¨ï¼‰
   - `transformer/transformer_layer.py` - ç†è§£å•å±‚å®ç°
   - `transformer/attention.py` - ç†è§£æ³¨æ„åŠ›æœºåˆ¶
   - `transformer/mlp.py` - ç†è§£MLPå±‚

3. **å¹¶è¡Œç­–ç•¥**ï¼ˆç¬¬4-6å‘¨ï¼‰
   - `tensor_parallel/layers.py` - ç†è§£TPå®ç°
   - `pipeline_parallel/schedules.py` - ç†è§£PPè°ƒåº¦
   - `distributed/distributed_data_parallel.py` - ç†è§£DPå®ç°

4. **æ¨¡å‹å®ç°**ï¼ˆç¬¬7-8å‘¨ï¼‰
   - `models/gpt/gpt_model.py` - ç†è§£å®Œæ•´æ¨¡å‹
   - `pretrain_gpt.py` - ç†è§£è®­ç»ƒè„šæœ¬

5. **é«˜çº§ç‰¹æ€§**ï¼ˆç¬¬9-10å‘¨ï¼‰
   - `optimizer/distrib_optimizer.py` - åˆ†å¸ƒå¼ä¼˜åŒ–å™¨
   - `inference/` - æ¨ç†å¼•æ“
   - `dist_checkpointing/` - æ£€æŸ¥ç‚¹ç³»ç»Ÿ

---

## 9. ä»£ç é˜…è¯»æŠ€å·§

### 9.1 å…³é”®æ–‡ä»¶é˜…è¯»é¡ºåº

**å¿…è¯»æ–‡ä»¶**ï¼ˆç†è§£æ ¸å¿ƒæ¶æ„ï¼‰ï¼š
1. `megatron/core/parallel_state.py` - å¹¶è¡ŒçŠ¶æ€ç®¡ç†
2. `megatron/core/transformer/transformer_layer.py` - Transformerå±‚
3. `megatron/core/models/gpt/gpt_model.py` - GPTæ¨¡å‹
4. `pretrain_gpt.py` - è®­ç»ƒä¸»æµç¨‹
5. `megatron/training/training.py` - è®­ç»ƒå¾ªç¯

**é‡è¦æ–‡ä»¶**ï¼ˆæ·±å…¥ç†è§£ï¼‰ï¼š
1. `megatron/core/pipeline_parallel/schedules.py` - æµæ°´çº¿è°ƒåº¦
2. `megatron/core/tensor_parallel/layers.py` - å¼ é‡å¹¶è¡Œ
3. `megatron/core/optimizer/distrib_optimizer.py` - åˆ†å¸ƒå¼ä¼˜åŒ–å™¨
4. `megatron/core/distributed/distributed_data_parallel.py` - æ•°æ®å¹¶è¡Œ

### 9.2 è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨ `print_rank_0()`**ï¼šåªåœ¨rank 0æ‰“å°ï¼Œé¿å…è¾“å‡ºæ··ä¹±
2. **ä½¿ç”¨ `torch.distributed.barrier()`**ï¼šåŒæ­¥æ‰€æœ‰è¿›ç¨‹
3. **å•GPUæ¨¡å¼**ï¼šå…ˆå•GPUéªŒè¯é€»è¾‘ï¼Œå†æ‰©å±•åˆ°å¤šGPU
4. **é˜…è¯»æµ‹è¯•ä»£ç **ï¼š`tests/unit_tests/` ä¸­çš„æµ‹è¯•æ˜¯å¾ˆå¥½çš„å­¦ä¹ ææ–™

---

## 10. è¯¦ç»†æ¨¡å—äº¤äº’å›¾

### 10.1 è®­ç»ƒæ—¶æ¨¡å—äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è®­ç»ƒæ—¶æ¨¡å—äº¤äº’åºåˆ—å›¾                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

pretrain_gpt.py    initialize.py    parallel_state.py    gpt_model.py
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚  åˆå§‹åŒ–åˆ†å¸ƒå¼      â”‚                  â”‚                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚
     â”‚                  â”‚  åˆ›å»ºå¹¶è¡Œç»„       â”‚                  â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚  model_provider()â”‚                  â”‚                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚                  â”‚                  â”‚  åˆ›å»ºTransformerå±‚â”‚
     â”‚                  â”‚                  â”‚                  â”œâ”€â”€â–º transformer_layer.py
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚ ä½¿ç”¨TPå±‚
     â”‚                  â”‚                  â”‚                  â”‚         â”œâ”€â”€â–º tensor_parallel
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚  å‡†å¤‡æ•°æ®é›†      â”‚                  â”‚                  â”‚         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º datasets
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚  åˆ›å»ºä¼˜åŒ–å™¨      â”‚                  â”‚                  â”‚         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º optimizer
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚  å¼€å§‹è®­ç»ƒå¾ªç¯    â”‚                  â”‚                  â”‚         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º pipeline_parallel
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
pipeline_parallel â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º forward()
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
gpt_model.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º forward()
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
transformer_layer â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º å‰å‘ä¼ æ’­
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
tensor_parallel â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º TPé€šä¿¡
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
pipeline_parallel â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º backward()
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
gpt_model.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º backward()
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
optimizer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º optimizer.step()
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
tensor_parallel â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º æ¢¯åº¦åŒæ­¥
     â”‚                  â”‚                  â”‚                  â”‚         â”‚
```

### 10.2 å¹¶è¡Œç­–ç•¥ç»„åˆç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          8 GPUs é…ç½®ç¤ºä¾‹                                     â”‚
â”‚                    TP=2, PP=2, DP=2 ç»„åˆç­–ç•¥                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TP=2 (å¼ é‡å¹¶è¡Œ)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ GPU 0-1      â”‚              â”‚ GPU 2-3      â”‚                            â”‚
â”‚  â”‚              â”‚              â”‚              â”‚                            â”‚
â”‚  â”‚ TP Group 0   â”‚              â”‚ TP Group 1   â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PP=2 (æµæ°´çº¿å¹¶è¡Œ)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Pipeline Stage 0                                             â”‚          â”‚
â”‚  â”‚                                                               â”‚          â”‚
â”‚  â”‚  GPU 0-3 (åŒ…å« TP Group 0 å’Œ TP Group 1)                     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                        â”‚                                                     â”‚
â”‚                        â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Pipeline Stage 1                                             â”‚          â”‚
â”‚  â”‚                                                               â”‚          â”‚
â”‚  â”‚  GPU 4-7                                                     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Parallel 0   â”‚          â”‚ Data Parallel 1  â”‚
â”‚                   â”‚          â”‚                   â”‚
â”‚ GPU 0, 2, 4, 6    â”‚          â”‚ GPU 1, 3, 5, 7    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3 å†…å­˜ç®¡ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å†…å­˜ä¼˜åŒ–ç­–ç•¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å†…å­˜ä¼˜åŒ–æŠ€æœ¯                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ¿€æ´»é‡è®¡ç®—        â”‚    â”‚ FSDPåˆ†ç‰‡         â”‚    â”‚ åºåˆ—å¹¶è¡Œ          â”‚     â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚     â”‚
â”‚  â”‚ recompute-      â”‚    â”‚ å‚æ•°/æ¢¯åº¦/        â”‚    â”‚ Sequence        â”‚     â”‚
â”‚  â”‚ activations     â”‚    â”‚ ä¼˜åŒ–å™¨çŠ¶æ€        â”‚    â”‚ Parallelism     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â–²                        â–²                        â–²                 â”‚
â”‚         â”‚                        â”‚                        â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                          â”‚    æ¨¡å‹       â”‚                                 â”‚
â”‚                          â”‚    Model     â”‚                                 â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ CPUå¸è½½          â”‚    â”‚ FSDPåˆ†ç‰‡         â”‚                              â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚                              â”‚
â”‚  â”‚ optimizer CPU   â”‚    â”‚ å‚æ•°/æ¢¯åº¦/        â”‚                              â”‚
â”‚  â”‚ offload         â”‚    â”‚ ä¼˜åŒ–å™¨çŠ¶æ€        â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚         â–²                        â–²                                          â”‚
â”‚         â”‚                        â”‚                                          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                          â”‚   ä¼˜åŒ–å™¨      â”‚                                 â”‚
â”‚                          â”‚  Optimizer    â”‚                                 â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                              â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                          â”‚ FP8æ··åˆç²¾åº¦    â”‚                                 â”‚
â”‚                          â”‚               â”‚                                 â”‚
â”‚                          â”‚ å‡å°‘å†…å­˜å ç”¨   â”‚                                 â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                  â–²                                          â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                          â”‚   è®­ç»ƒæµç¨‹     â”‚                                 â”‚
â”‚                          â”‚   Training    â”‚                                 â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 11. æ–‡ä»¶åŠŸèƒ½é€ŸæŸ¥è¡¨

### 11.1 æ ¸å¿ƒæ–‡ä»¶åŠŸèƒ½é€ŸæŸ¥

| æ¨¡å— | å…³é”®æ–‡ä»¶ | æ ¸å¿ƒåŠŸèƒ½ | é‡è¦æ€§ |
|------|---------|---------|--------|
| **å¹¶è¡Œç®¡ç†** | `parallel_state.py` | ç®¡ç†æ‰€æœ‰å¹¶è¡Œç»„ | â­â­â­â­â­ |
| **é…ç½®** | `config.py` | é…ç½®å‚æ•°å®šä¹‰ | â­â­â­â­ |
| **Transformer** | `transformer_layer.py` | Transformerå±‚å®ç° | â­â­â­â­â­ |
| **æ³¨æ„åŠ›** | `attention.py` | æ³¨æ„åŠ›æœºåˆ¶ | â­â­â­â­â­ |
| **GPTæ¨¡å‹** | `gpt_model.py` | GPTå®Œæ•´æ¨¡å‹ | â­â­â­â­â­ |
| **TP** | `tensor_parallel/layers.py` | å¼ é‡å¹¶è¡Œå±‚ | â­â­â­â­â­ |
| **PP** | `pipeline_parallel/schedules.py` | æµæ°´çº¿è°ƒåº¦ | â­â­â­â­â­ |
| **DP** | `distributed_data_parallel.py` | æ•°æ®å¹¶è¡Œ | â­â­â­â­ |
| **ä¼˜åŒ–å™¨** | `optimizer.py` | ä¼˜åŒ–å™¨å®ç° | â­â­â­â­ |
| **åˆ†å¸ƒå¼ä¼˜åŒ–å™¨** | `distrib_optimizer.py` | åˆ†ç‰‡ä¼˜åŒ–å™¨ | â­â­â­â­ |
| **æ•°æ®é›†** | `gpt_dataset.py` | GPTæ•°æ®é›† | â­â­â­â­ |
| **è®­ç»ƒå¾ªç¯** | `training.py` | è®­ç»ƒä¸»å¾ªç¯ | â­â­â­â­â­ |
| **æ£€æŸ¥ç‚¹** | `dist_checkpointing/core.py` | åˆ†å¸ƒå¼æ£€æŸ¥ç‚¹ | â­â­â­â­ |

### 11.2 ä»£ç è¡Œæ•°ç»Ÿè®¡ï¼ˆå‚è€ƒï¼‰

| æ¨¡å— | ä¸»è¦æ–‡ä»¶ | ä¼°è®¡è¡Œæ•° | å¤æ‚åº¦ |
|------|---------|---------|--------|
| `parallel_state.py` | å•æ–‡ä»¶ | ~2000è¡Œ | é«˜ |
| `transformer_layer.py` | å•æ–‡ä»¶ | ~500è¡Œ | ä¸­ |
| `gpt_model.py` | å•æ–‡ä»¶ | ~800è¡Œ | ä¸­ |
| `schedules.py` | å•æ–‡ä»¶ | ~2000è¡Œ | é«˜ |
| `distrib_optimizer.py` | å•æ–‡ä»¶ | ~1000è¡Œ | é«˜ |

## 12. æ€»ç»“

### 12.1 æ ¸å¿ƒæ¶æ„ç‰¹ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªç»„ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨
2. **å¹¶è¡ŒæŠ½è±¡**ï¼šé€šè¿‡ `parallel_state.py` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¹¶è¡Œç­–ç•¥
3. **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡ Layer Spec ç³»ç»Ÿå¯ä»¥è½»æ¾æ‰©å±•æ–°æ¶æ„
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šèåˆå†…æ ¸ã€CUDA Graphsã€é€šä¿¡é‡å ç­‰ä¼˜åŒ–
5. **åˆ†å±‚æ¶æ„**ï¼š
   - **åº•å±‚**ï¼šå¹¶è¡Œé€šä¿¡ã€èåˆå†…æ ¸
   - **ä¸­å±‚**ï¼šTransformerç»„ä»¶ã€å¹¶è¡Œç­–ç•¥
   - **ä¸Šå±‚**ï¼šæ¨¡å‹å®ç°ã€è®­ç»ƒæ¡†æ¶

### 12.2 å…³é”®è®¾è®¡æ¨¡å¼

1. **å·¥å‚æ¨¡å¼**ï¼š`model_provider()` å‡½æ•°åˆ›å»ºæ¨¡å‹
2. **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒçš„å¹¶è¡Œç­–ç•¥ã€è°ƒåº¦ç­–ç•¥
3. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼šè®­ç»ƒå¾ªç¯çš„é€šç”¨æ¡†æ¶
4. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šæ£€æŸ¥ç‚¹å’Œæ—¥å¿—ç³»ç»Ÿ
5. **é€‚é…å™¨æ¨¡å¼**ï¼šä¸åŒå¹¶è¡Œç­–ç•¥çš„é€‚é…å™¨

### 12.3 å­¦ä¹ å»ºè®®

1. **ä»ç®€å•åˆ°å¤æ‚**ï¼šå…ˆç†è§£å•GPUè®­ç»ƒï¼Œå†ç†è§£å¹¶è¡Œè®­ç»ƒ
2. **ä»æ•´ä½“åˆ°ç»†èŠ‚**ï¼šå…ˆçœ‹æ•´ä½“æ¶æ„ï¼Œå†æ·±å…¥å…·ä½“å®ç°
3. **ç†è®ºä¸å®è·µç»“åˆ**ï¼šé˜…è¯»ä»£ç çš„åŒæ—¶è¿è¡Œç¤ºä¾‹
4. **é˜…è¯»æµ‹è¯•ä»£ç **ï¼š`tests/unit_tests/` ä¸­çš„æµ‹è¯•æ˜¯å¾ˆå¥½çš„å­¦ä¹ ææ–™
5. **ç»˜åˆ¶è‡ªå·±çš„æ¶æ„å›¾**ï¼šåœ¨ç†è§£çš„åŸºç¡€ä¸Šç»˜åˆ¶è‡ªå·±çš„æ¶æ„å›¾

### 12.4 å¸¸è§é—®é¢˜

**Q: å¦‚ä½•å¿«é€Ÿå®šä½æŸä¸ªåŠŸèƒ½çš„å®ç°ï¼Ÿ**
A: 
- å¹¶è¡Œç›¸å…³ â†’ `parallel_state.py`, `tensor_parallel/`, `pipeline_parallel/`
- æ¨¡å‹ç›¸å…³ â†’ `models/`, `transformer/`
- è®­ç»ƒç›¸å…³ â†’ `training/`, `pretrain_*.py`
- æ•°æ®ç›¸å…³ â†’ `datasets/`, `tools/preprocess_data.py`

**Q: å¦‚ä½•ç†è§£å¤æ‚çš„å¹¶è¡Œç»„åˆï¼Ÿ**
A: 
1. å…ˆç†è§£å•ä¸ªå¹¶è¡Œç­–ç•¥
2. ç†è§£å¹¶è¡Œç»„çš„å…³ç³»ï¼ˆé€šè¿‡ `parallel_state.py`ï¼‰
3. æŸ¥çœ‹é…ç½®ç¤ºä¾‹ï¼ˆ`examples/` ç›®å½•ï¼‰
4. ä½¿ç”¨å°è§„æ¨¡æµ‹è¯•éªŒè¯ç†è§£

**Q: å¦‚ä½•æ‰©å±•æ–°æ¨¡å‹ï¼Ÿ**
A:
1. å‚è€ƒ `models/gpt/` çš„å®ç°
2. å®šä¹‰è‡ªå·±çš„ Layer Spec
3. å®ç°æ¨¡å‹ç±»ï¼ˆç»§æ‰¿ `LanguageModule`ï¼‰
4. åˆ›å»ºè®­ç»ƒè„šæœ¬ï¼ˆå‚è€ƒ `pretrain_gpt.py`ï¼‰

---

**æœ¬æ¶æ„æ–‡æ¡£å°†éšç€ä»£ç åº“çš„å‘å±•æŒç»­æ›´æ–°ã€‚å»ºè®®ç»“åˆä»£ç é˜…è¯»å’Œå®é™…è¿è¡Œæ¥æ·±å…¥ç†è§£ã€‚**

